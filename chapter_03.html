<!DOCTYPE html>
<html class="writer-html5" lang="ru" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Глава 3. Локализация Aiogram, создание переводов и работа с Babel. &mdash; документация i18n and l10n aiogram tutorial 1.0</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=9ca2116e"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="_static/copybutton.js?v=f281be69"></script>
        <script src="_static/translations.js?v=29b1f277"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Алфавитный указатель" href="genindex.html" />
    <link rel="search" title="Поиск" href="search.html" />
    <link rel="next" title="Глава 4. Локализация и интернационализация на базе проект Fluent от Mozilla." href="chapter_04.html" />
    <link rel="prev" title="Глава 2. Интернационализация в Aiogram утилитами GNU gettext." href="chapter_02.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            i18n and l10n aiogram tutorial
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Поиск в документации" aria-label="Поиск в документации" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Меню навигации">
              <p class="caption" role="heading"><span class="caption-text">Оглавление:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter_01.html">Глава 1. Интернационализация и Локализация.</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_02.html">Глава 2. Интернационализация в Aiogram утилитами GNU gettext.</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Глава 3. Локализация Aiogram, создание переводов и работа с Babel.</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">Шаблоны переводов</a></li>
<li class="toctree-l2"><a class="reference internal" href="#po">Файлы переводов .po</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">Внесение изменений в файлы переводов .po</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">Множественные формы</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mo">Компиляция переводов, файлы формата mo.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id4">Финальный результат.</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter_04.html">Глава 4. Локализация и интернационализация на базе проект Fluent от Mozilla.</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_05.html">Глава 5. Интернационализация в Aiogram с использованием Fluent.</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_06.html">Глава 6. Локализация Aiogram с помощью проекта Fluent.</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_07.html">Глава 7. Динамическое определение и переключение языка в Aiogram</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_08.html">Заключение и домашнее задание.</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Меню навигации для мобильных устройств" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">i18n and l10n aiogram tutorial</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Навигация по страницам">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Глава 3. Локализация Aiogram, создание переводов и работа с Babel.</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/chapter_03.rst.txt" rel="nofollow"> Просмотреть исходный код страницы</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="aiogram-babel">
<h1>Глава 3. Локализация Aiogram, создание переводов и работа с Babel.<a class="headerlink" href="#aiogram-babel" title="Link to this heading"></a></h1>
<section id="id1">
<h2>Шаблоны переводов<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<p>Переходим ко второму шагу к локализации. Теперь нам необходимо создать
сами переводы, основываясь на переменных, которые уже есть в нашем коде
и создать папки по такой структуре.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>...
locales
├── messages.pot
├── en
│   └── LC_MESSAGES
│       └── my-super-bot.po
├── ru
│   └── LC_MESSAGES
│       └── my-super-bot.po
...
</pre></div>
</div>
<p>Предварительно нужно только создать папку locales в корне проекта.
Остальная структура создается автоматически с помощью ранее
установленного пакета утилит Babel.</p>
<p>Создаем основу — шаблон переводов. Запускаем в корне проекта из
командной строки команду:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pybabel<span class="w"> </span>extract<span class="w"> </span>--input-dirs<span class="o">=</span>.<span class="w"> </span>-o<span class="w"> </span>locales/messages.pot
</pre></div>
</div>
<p>Утилита проходит по нашим файлам и извлекает все строковые переменные,
обернутые функциями <code class="docutils literal notranslate"><span class="pre">_()</span></code> и <code class="docutils literal notranslate"><span class="pre">__()</span></code>, в файл шаблона messages.pot.</p>
<p>У нас получится файл <code class="docutils literal notranslate"><span class="pre">.pot</span></code> (Portable Object Template, а в
простонародье горшок) — это шаблон переводов, на основании которого
генерируются переводы:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">locales/messages.pot</span><a class="headerlink" href="#id5" title="Link to this code"></a></div>
<div class="highlight-pot notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="c1"># Translations template for Bot Super Project.</span>
</span><span class="hll"><span class="c1"># Copyright (C) 2024 John Doe</span>
</span><span class="c1"># This file is distributed under the same license as the Bot Super Project</span>
<span class="c1"># project.</span>
<span class="c1"># FIRST AUTHOR &lt;EMAIL@ADDRESS&gt;, 2024.</span>
<span class="c1">#</span>
<span class="kt">#, fuzzy</span>
<span class="nv">msgid</span> <span class="s">&quot;&quot;</span>
<span class="nv">msgstr</span> <span class="s">&quot;&quot;</span>
<span class="hll"><span class="s">&quot;</span><span class="py">Project-Id-Version:</span><span class="s"> Bot Super Project 0.1\n&quot;</span>
</span><span class="hll"><span class="s">&quot;</span><span class="py">Report-Msgid-Bugs-To:</span><span class="s"> john@doe-email.com\n&quot;</span>
</span><span class="s">&quot;</span><span class="py">POT-Creation-Date:</span><span class="s"> 2024-01-12 16:11+0500\n&quot;</span>
<span class="s">&quot;</span><span class="py">PO-Revision-Date:</span><span class="s"> YEAR-MO-DA HO:MI+ZONE\n&quot;</span>
<span class="s">&quot;</span><span class="py">Last-Translator:</span><span class="s"> FULL NAME &lt;EMAIL@ADDRESS&gt;\n&quot;</span>
<span class="s">&quot;</span><span class="py">Language-Team:</span><span class="s"> LANGUAGE &lt;LL@li.org&gt;\n&quot;</span>
<span class="s">&quot;</span><span class="py">MIME-Version:</span><span class="s"> 1.0\n&quot;</span>
<span class="s">&quot;</span><span class="py">Content-Type:</span><span class="s"> text/plain; charset=utf-8\n&quot;</span>
<span class="s">&quot;</span><span class="py">Content-Transfer-Encoding:</span><span class="s"> 8bit\n&quot;</span>
<span class="s">&quot;</span><span class="py">Generated-By:</span><span class="s"> Babel 2.13.1\n&quot;</span>

<span class="kd">#: lesson1.py:13</span>
<span class="nv">msgid</span> <span class="s">&quot;Hello, {name}!&quot;</span>
<span class="nv">msgstr</span> <span class="s">&quot;&quot;</span>
</pre></div>
</div>
</div>
<p>Обратите внимание, что при работе с gettext и Babel комментари,
начинающиеся с <code class="docutils literal notranslate"><span class="pre">#</span></code>, являются значимыми — то есть их нельзя удалять.</p>
<p>Файл мы заполним своими данными (выделенные строки): это название проекта,
версия, копирайты и электронный адрес для связи в случае багов. По идее
это можно сразу сделать из командной строке при формировании шаблона
переводов:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pybabel<span class="w"> </span>extract<span class="w"> </span>-o<span class="w"> </span>locales/messages.pot<span class="w"> </span>--copyright-holder<span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="w"> </span>--project<span class="o">=</span><span class="s2">&quot;Bot Super Project&quot;</span><span class="w"> </span>--version<span class="o">=</span><span class="m">0</span>.1<span class="w"> </span>--msgid-bugs-address<span class="o">=</span>john@doe-email.com<span class="w"> </span>--input-dirs<span class="o">=</span>.
</pre></div>
</div>
<p>Шаблон генерируется каждый раз после исправления или доработки кода,
поэтому мы не храним его в репозитории исходников git. На основании
шаблона будут создаваться файлы переводов на нужные нам языки.</p>
<p>Давайте создадим файл перевода на английский язык. Выполним в командной
строке:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pybabel<span class="w"> </span>init<span class="w"> </span>-i<span class="w"> </span>locales/messages.pot<span class="w"> </span>-d<span class="w"> </span>locales<span class="w"> </span>-D<span class="w"> </span>my-super-bot<span class="w"> </span>-l<span class="w"> </span>en
</pre></div>
</div>
<p>А затем на русский:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pybabel<span class="w"> </span>init<span class="w"> </span>-i<span class="w"> </span>locales/messages.pot<span class="w"> </span>-d<span class="w"> </span>locales<span class="w"> </span>-D<span class="w"> </span>my-super-bot<span class="w"> </span>-l<span class="w"> </span>ru
</pre></div>
</div>
<p>Где,</p>
<p><code class="docutils literal notranslate"><span class="pre">-i</span> <span class="pre">locales/messages.pot</span></code> - путь к нашему шаблону .pot</p>
<p><code class="docutils literal notranslate"><span class="pre">-d</span> <span class="pre">locales</span></code> - наш каталог переводов</p>
<p><code class="docutils literal notranslate"><span class="pre">-D</span> <span class="pre">my-super-bot</span></code> - наш домен переводов</p>
<p><code class="docutils literal notranslate"><span class="pre">-l</span> <span class="pre">en</span></code> — код языка.</p>
<p>Будет создан файл перевода <code class="docutils literal notranslate"><span class="pre">my-super-bot.po</span></code> в папке <code class="docutils literal notranslate"><span class="pre">locales/en/LC_MESSAGES/</span></code> и <code class="docutils literal notranslate"><span class="pre">locales/ru/LC_MESSAGES/</span></code>.</p>
</section>
<section id="po">
<h2>Файлы переводов .po<a class="headerlink" href="#po" title="Link to this heading"></a></h2>
<p>Файлы в формате <code class="docutils literal notranslate"><span class="pre">.po</span></code> предназначены для переводчиков. И храним мы их в
репозитории в development ветке. Они нам нужны на случай изменения или
добавления строк в проекте. Генерация новых <code class="docutils literal notranslate"><span class="pre">.po</span></code> файлов происходит с
учетом старых. Об этом чуть позже. Сначала откроем созданные файлы и
отредактируем их.</p>
<p>Нас интересуют строки вида</p>
<div class="highlight-po notranslate"><div class="highlight"><pre><span></span><span class="kd">#: lesson1.py:13</span>
<span class="nv">msgid</span> <span class="s">&quot;Hello, {name}!&quot;</span>
<span class="nv">msgstr</span> <span class="s">&quot;&quot;</span>
</pre></div>
</div>
<p>В комментарии указан файл, откуда взялась текстовая строка и номер
строки в этом файле. Затем идентификатор <code class="docutils literal notranslate"><span class="pre">msgid</span></code> и перевод <code class="docutils literal notranslate"><span class="pre">msgstr</span></code>,
который будет подставлен пользователю с выбранным языком. Заполняем
перевод <code class="docutils literal notranslate"><span class="pre">msgstr</span></code> в обоих локалях ru и en.</p>
<p>Для ru</p>
<div class="highlight-po notranslate"><div class="highlight"><pre><span></span><span class="kd">#: lesson1.py:13</span>
<span class="nv">msgid</span> <span class="s">&quot;Hello, {name}!&quot;</span>
<span class="nv">msgstr</span> <span class="s">&quot;Привет, {name}!&quot;</span>
</pre></div>
</div>
<p>Для en</p>
<div class="highlight-po notranslate"><div class="highlight"><pre><span></span><span class="kd">#: lesson1.py:13</span>
<span class="nv">msgid</span> <span class="s">&quot;Hello, {name}!&quot;</span>
<span class="nv">msgstr</span> <span class="s">&quot;Hello, {name}!&quot;</span>
</pre></div>
</div>
<p>Теперь пользователь у которого язык английский, получит английское
сообщение, а русский — русское. Естественно какой у пользователя язык,
мы должны считать через наш middleware i18n.</p>
<p>Затем обязательно компилируем переводы в формат <code class="docutils literal notranslate"><span class="pre">.mo</span></code> и готово:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pybabel</span> <span class="nb">compile</span> <span class="o">-</span><span class="n">d</span> <span class="n">locales</span> <span class="o">-</span><span class="n">D</span> <span class="n">my</span><span class="o">-</span><span class="nb">super</span><span class="o">-</span><span class="n">bot</span>
</pre></div>
</div>
</section>
<section id="id2">
<h2>Внесение изменений в файлы переводов .po<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<p>Разберем еще один момент, связанный с изменениями переводов.</p>
<p>В какой-то момент мы решили изменить логику бота. И изменили код
программы, изменив старые строки и добавив новые. Естественно мы вносим
изменения в код в парадигме интернационализации.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">lesson1.py</span><a class="headerlink" href="#id6" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">aiogram</span> <span class="kn">import</span> <span class="n">Bot</span><span class="p">,</span> <span class="n">Dispatcher</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">html</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">aiogram.types</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kn">from</span> <span class="nn">aiogram.utils.i18n</span> <span class="kn">import</span> <span class="n">gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="linenos"> 5</span><span class="kn">from</span> <span class="nn">aiogram.utils.i18n</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">__</span>
<span class="linenos"> 6</span><span class="kn">from</span> <span class="nn">aiogram.utils.i18n</span> <span class="kn">import</span> <span class="n">I18n</span><span class="p">,</span> <span class="n">ConstI18nMiddleware</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="n">TOKEN</span> <span class="o">=</span> <span class="s2">&quot;token&quot;</span>
<span class="linenos">10</span><span class="n">dp</span> <span class="o">=</span> <span class="n">Dispatcher</span><span class="p">()</span>
<span class="linenos">11</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="n">__</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">))</span>
<span class="linenos">14</span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler_1</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="hll"><span class="linenos">15</span>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Welcome, </span><span class="si">{name}</span><span class="s2">!&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">html</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">full_name</span><span class="p">)))</span>
</span><span class="hll"><span class="linenos">16</span>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;How many coins do you have? Input number, please:&quot;</span><span class="p">))</span>
</span><span class="linenos">17</span>
<span class="linenos">18</span><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="linenos">19</span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler_2</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="hll"><span class="linenos">20</span>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;You have </span><span class="si">{}</span><span class="s2"> coins!&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
</span><span class="linenos">21</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">24</span>    <span class="n">bot</span> <span class="o">=</span> <span class="n">Bot</span><span class="p">(</span><span class="n">TOKEN</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
<span class="linenos">25</span>    <span class="n">i18n</span> <span class="o">=</span> <span class="n">I18n</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;locales&quot;</span><span class="p">,</span> <span class="n">default_locale</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;my-super-bot&quot;</span><span class="p">)</span>
<span class="linenos">26</span>    <span class="n">dp</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">outer_middleware</span><span class="p">(</span><span class="n">ConstI18nMiddleware</span><span class="p">(</span><span class="n">locale</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="n">i18n</span><span class="o">=</span><span class="n">i18n</span><span class="p">))</span>
<span class="linenos">27</span>    <span class="n">dp</span><span class="o">.</span><span class="n">run_polling</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>
<span class="linenos">28</span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="linenos">31</span>    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Мы добавили вопрос к пользователю и переделали приветственное сообщение.</p>
<p>Теперь нам снова нужно извлечь строки. Формируем <code class="docutils literal notranslate"><span class="pre">.pot</span></code> файл. Для
удобства в версию добавляем минорный релиз 0.1.1.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pybabel<span class="w"> </span>extract<span class="w"> </span>-o<span class="w"> </span>locales/messages.pot<span class="w"> </span>--copyright-holder<span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="w"> </span>--project<span class="o">=</span><span class="s2">&quot;Bot Super Project&quot;</span><span class="w"> </span>—version<span class="o">=</span><span class="m">0</span>.1.1<span class="w"> </span>--msgid-bugs-address<span class="o">=</span>john@doe-email.com<span class="w"> </span>—input-dirs<span class="o">=</span>.
</pre></div>
</div>
<p>И получаем новый шаблон:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">locales/messages.pot</span><a class="headerlink" href="#id7" title="Link to this code"></a></div>
<div class="highlight-pot notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1"># Translations template for Bot Super Project.</span>
<span class="linenos"> 2</span><span class="c1"># Copyright (C) 2024 John Doe</span>
<span class="linenos"> 3</span><span class="c1"># This file is distributed under the same license as the Bot Super Project</span>
<span class="linenos"> 4</span><span class="c1"># project.</span>
<span class="linenos"> 5</span><span class="c1"># FIRST AUTHOR &lt;EMAIL@ADDRESS&gt;, 2024.</span>
<span class="linenos"> 6</span><span class="c1">#</span>
<span class="linenos"> 7</span><span class="kt">#, fuzzy</span>
<span class="linenos"> 8</span><span class="nv">msgid</span> <span class="s">&quot;&quot;</span>
<span class="linenos"> 9</span><span class="nv">msgstr</span> <span class="s">&quot;&quot;</span>
<span class="linenos">10</span><span class="s">&quot;</span><span class="py">Project-Id-Version:</span><span class="s"> Bot Super Project 0.1.1\n&quot;</span>
<span class="linenos">11</span><span class="s">&quot;</span><span class="py">Report-Msgid-Bugs-To:</span><span class="s"> john@doe-email.com\n&quot;</span>
<span class="linenos">12</span><span class="s">&quot;</span><span class="py">POT-Creation-Date:</span><span class="s"> 2024-01-12 17:25+0500\n&quot;</span>
<span class="linenos">13</span><span class="s">&quot;</span><span class="py">PO-Revision-Date:</span><span class="s"> YEAR-MO-DA HO:MI+ZONE\n&quot;</span>
<span class="linenos">14</span><span class="s">&quot;</span><span class="py">Last-Translator:</span><span class="s"> FULL NAME &lt;EMAIL@ADDRESS&gt;\n&quot;</span>
<span class="linenos">15</span><span class="s">&quot;</span><span class="py">Language-Team:</span><span class="s"> LANGUAGE &lt;LL@li.org&gt;\n&quot;</span>
<span class="linenos">16</span><span class="s">&quot;</span><span class="py">MIME-Version:</span><span class="s"> 1.0\n&quot;</span>
<span class="linenos">17</span><span class="s">&quot;</span><span class="py">Content-Type:</span><span class="s"> text/plain; charset=utf-8\n&quot;</span>
<span class="linenos">18</span><span class="s">&quot;</span><span class="py">Content-Transfer-Encoding:</span><span class="s"> 8bit\n&quot;</span>
<span class="linenos">19</span><span class="s">&quot;</span><span class="py">Generated-By:</span><span class="s"> Babel 2.13.1\n&quot;</span>
<span class="linenos">20</span>
<span class="hll"><span class="linenos">21</span><span class="kd">#: lesson1.py:15</span>
</span><span class="hll"><span class="linenos">22</span><span class="nv">msgid</span> <span class="s">&quot;Welcome, {name}!&quot;</span>
</span><span class="linenos">23</span><span class="nv">msgstr</span> <span class="s">&quot;&quot;</span>
<span class="linenos">24</span>
<span class="hll"><span class="linenos">25</span><span class="kd">#: lesson1.py:16</span>
</span><span class="hll"><span class="linenos">26</span><span class="nv">msgid</span> <span class="s">&quot;How many coins do you have? Input number, please:&quot;</span>
</span><span class="linenos">27</span><span class="nv">msgstr</span> <span class="s">&quot;&quot;</span>
<span class="linenos">28</span>
<span class="hll"><span class="linenos">29</span><span class="kd">#: lesson1.py:20</span>
</span><span class="hll"><span class="linenos">30</span><span class="nv">msgid</span> <span class="s">&quot;You have {} coins!&quot;</span>
</span><span class="linenos">31</span><span class="nv">msgstr</span> <span class="s">&quot;&quot;</span>
</pre></div>
</div>
</div>
<p>Обновляем файлы переводов командой update.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pybabel<span class="w"> </span>update<span class="w"> </span>-i<span class="w"> </span>locales/messages.pot<span class="w"> </span>-d<span class="w"> </span>locales<span class="w"> </span>-D<span class="w"> </span>my-super-bot<span class="w"> </span>-l<span class="w"> </span>ru
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pybabel<span class="w"> </span>update<span class="w"> </span>-i<span class="w"> </span>locales/messages.pot<span class="w"> </span>-d<span class="w"> </span>locales<span class="w"> </span>-D<span class="w"> </span>my-super-bot<span class="w"> </span>-l<span class="w"> </span>en
</pre></div>
</div>
<p>И мы видим следующую картину.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">locales/ru/LC_MESSAGES/my-super-bot.po</span><a class="headerlink" href="#id8" title="Link to this code"></a></div>
<div class="highlight-po notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1"># Russian translations for Bot Super Project.</span>
<span class="linenos"> 2</span><span class="c1"># Copyright (C) 2024 John Doe</span>
<span class="linenos"> 3</span><span class="c1"># This file is distributed under the same license as the Bot Super Project</span>
<span class="linenos"> 4</span><span class="c1"># project.</span>
<span class="linenos"> 5</span><span class="c1"># FIRST AUTHOR &lt;EMAIL@ADDRESS&gt;, 2024.</span>
<span class="linenos"> 6</span><span class="c1">#</span>
<span class="linenos"> 7</span><span class="nv">msgid</span> <span class="s">&quot;&quot;</span>
<span class="linenos"> 8</span><span class="nv">msgstr</span> <span class="s">&quot;&quot;</span>
<span class="linenos"> 9</span><span class="s">&quot;</span><span class="py">Project-Id-Version:</span><span class="s"> Bot Super Project 0.1\n&quot;</span>
<span class="linenos">10</span><span class="s">&quot;</span><span class="py">Report-Msgid-Bugs-To:</span><span class="s"> john@doe-email.com\n&quot;</span>
<span class="linenos">11</span><span class="s">&quot;</span><span class="py">POT-Creation-Date:</span><span class="s"> 2024-01-12 17:28+0500\n&quot;</span>
<span class="linenos">12</span><span class="s">&quot;</span><span class="py">PO-Revision-Date:</span><span class="s"> 2024-01-12 16:16+0500\n&quot;</span>
<span class="linenos">13</span><span class="s">&quot;</span><span class="py">Last-Translator:</span><span class="s"> FULL NAME &lt;EMAIL@ADDRESS&gt;\n&quot;</span>
<span class="linenos">14</span><span class="s">&quot;</span><span class="py">Language:</span><span class="s"> ru\n&quot;</span>
<span class="linenos">15</span><span class="s">&quot;</span><span class="py">Language-Team:</span><span class="s"> ru &lt;LL@li.org&gt;\n&quot;</span>
<span class="linenos">16</span><span class="s">&quot;</span><span class="py">Plural-Forms:</span><span class="s"> nplurals=3; plural=(n%10==1 &amp;&amp; n%100!=11 ? 0 : n%10&gt;=2 &amp;&amp; &quot;</span>
<span class="linenos">17</span><span class="s">&quot;n%10&lt;=4 &amp;&amp; (n%100&lt;10 || n%100&gt;=20) ? 1 : 2);\n&quot;</span>
<span class="linenos">18</span><span class="s">&quot;</span><span class="py">MIME-Version:</span><span class="s"> 1.0\n&quot;</span>
<span class="linenos">19</span><span class="s">&quot;</span><span class="py">Content-Type:</span><span class="s"> text/plain; charset=utf-8\n&quot;</span>
<span class="linenos">20</span><span class="s">&quot;</span><span class="py">Content-Transfer-Encoding:</span><span class="s"> 8bit\n&quot;</span>
<span class="linenos">21</span><span class="s">&quot;</span><span class="py">Generated-By:</span><span class="s"> Babel 2.13.1\n&quot;</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="kd">#: lesson1.py:15</span>
<span class="hll"><span class="linenos">24</span><span class="kt">#, fuzzy</span>
</span><span class="hll"><span class="linenos">25</span><span class="nv">msgid</span> <span class="s">&quot;Welcome, {name}!&quot;</span>
</span><span class="hll"><span class="linenos">26</span><span class="nv">msgstr</span> <span class="s">&quot;Привет, {name}!&quot;</span>
</span><span class="linenos">27</span>
<span class="linenos">28</span><span class="kd">#: lesson1.py:16</span>
<span class="linenos">29</span><span class="nv">msgid</span> <span class="s">&quot;How many coins do you have? Input number, please:&quot;</span>
<span class="linenos">30</span><span class="nv">msgstr</span> <span class="s">&quot;&quot;</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="kd">#: lesson1.py:20</span>
<span class="linenos">33</span><span class="nv">msgid</span> <span class="s">&quot;You have {} coins!&quot;</span>
<span class="linenos">34</span><span class="nv">msgstr</span> <span class="s">&quot;&quot;</span>
</pre></div>
</div>
</div>
<p>Прежний перевод сохранился, но при этом у нас строка была изменена с
Hello на Welcome.</p>
<p>Babel увидел это, сохранил нам строку, но пометил перевод коментарием
<code class="docutils literal notranslate"><span class="pre">#,</span> <span class="pre">fuzzy</span></code> что обозначает нечеткий или неточный перевод. Если скомпилировать сразу,
то такая строка не будет переводиться и отображаться пользователю.</p>
<p>Нам нужно поправить текст и убрать эту метку <code class="docutils literal notranslate"><span class="pre">fuzzy</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">locales/ru/LC_MESSAGES/my-super-bot.po</span><a class="headerlink" href="#id9" title="Link to this code"></a></div>
<div class="highlight-po notranslate"><div class="highlight"><pre><span></span><span class="linenos">23</span><span class="kd">#: lesson1.py:15</span>
<span class="linenos">24</span><span class="nv">msgid</span> <span class="s">&quot;Welcome, {name}!&quot;</span>
<span class="linenos">25</span><span class="nv">msgstr</span> <span class="s">&quot;Добро пожаловать, {name}!&quot;</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="kd">#: lesson1.py:16</span>
<span class="linenos">28</span><span class="nv">msgid</span> <span class="s">&quot;How many coins do you have? Input number, please:&quot;</span>
<span class="linenos">29</span><span class="nv">msgstr</span> <span class="s">&quot;Сколько у тебя монет? Введи число, пожайлуйста:&quot;</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="kd">#: lesson1.py:20</span>
<span class="linenos">32</span><span class="nv">msgid</span> <span class="s">&quot;You have {} coins!&quot;</span>
<span class="linenos">33</span><span class="nv">msgstr</span> <span class="s">&quot;У тебя {} монет!&quot;</span>
</pre></div>
</div>
</div>
<p>То же самое делаем со вторым языком, и снова компилируем переводы.</p>
<p>В результате у нас все хорошо, кроме такого момента.</p>
<p>Если мы введем 1, то бот ответит <em>«У тебя 1 монет!»</em> или <em>«You have 1 coins!»</em>,
что с точки зрения грамматики любого языка — неверно.</p>
</section>
<section id="id3">
<h2>Множественные формы<a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<p>Например, в русском языке используются несколько множественных форм: 1 монета 2, 3 или 4 монет, 11 монет.
А если слово сообщения, то 1 сообщение, 2 сообщения, 10 сообщений. И в английском у нас тоже проблема
со множественными числами — 1 coins, хотя ожидалось 1 coin, 2 coins.</p>
<p>Давайте победим и эту историю.</p>
<p>Помните, я говорил о значащих комментариях в файлах <code class="docutils literal notranslate"><span class="pre">.pot</span></code> и <code class="docutils literal notranslate"><span class="pre">.po</span></code>.
В частности в файле переводов <code class="docutils literal notranslate"><span class="pre">.po</span></code> для каждого языка формируется формула,
которая определяет количество множественных форм и правила их формирования.
Тут и будет вся магия работы с переводами множественных форм. Она содержится в строчках:</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">locales/ru/LC_MESSAGES/my-super-bot.po</span><a class="headerlink" href="#id10" title="Link to this code"></a></div>
<div class="highlight-po notranslate"><div class="highlight"><pre><span></span><span class="linenos">16</span><span class="s">&quot;</span><span class="py">Plural-Forms:</span><span class="s"> nplurals=3; plural=(n%10==1 &amp;&amp; n%100!=11 ? 0 : n%10&gt;=2 &amp;&amp; &quot;</span>
<span class="linenos">17</span><span class="s">&quot;n%10&lt;=4 &amp;&amp; (n%100&lt;10 || n%100&gt;=20) ? 1 : 2);\n&quot;</span>
</pre></div>
</div>
</div>
<p>Это формула, по которой определяется для конкретного языка форма слова во множественном числе.
Формулу разберем потом. А для начала нам нужно вернуться к интернационализации нашего кода.</p>
<p>Функция gettext не умеет работать со множественными формами. Для этого
существует <a class="reference external" href="https://docs.python.org/3/library/gettext.html#gettext.ngettext" rel="noopener noreferrer" target="_blank">ngettext</a> из стандартной библиотеки python.
Однако для удобства в Aiogram это уже все спрятано в функции <code class="docutils literal notranslate"><span class="pre">gettext</span></code> из <code class="docutils literal notranslate"><span class="pre">aiogram.utils.i18n</span></code>.</p>
<p>Добавляем два идентификатора: передаем фразу в единственном, затем во множественном числе, и аргумент, принимающий число.
Не забываем привести принимаемый от пользователя текст к int.</p>
<p>Изменим наш код.</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">lesson1.py</span><a class="headerlink" href="#id11" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">18</span><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="linenos">19</span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler_2</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">20</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">21</span>        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="linenos">22</span>        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;You have </span><span class="si">{}</span><span class="s2"> coin!&quot;</span><span class="p">,</span> <span class="s2">&quot;You have </span><span class="si">{}</span><span class="s2"> coins!&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<span class="linenos">23</span>    <span class="k">except</span><span class="p">:</span>
<span class="linenos">24</span>        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Please, enter a number&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Теперь снова нужно произвести извлечение строк с помощью Babel. Для
извлечения строк с разным количеством аргументов, нам нужно запускать
pybabel extract с опциями <code class="docutils literal notranslate"><span class="pre">-k</span> <span class="pre">_:1,1t</span></code> <code class="docutils literal notranslate"><span class="pre">-k</span> <span class="pre">_:1,2</span></code> для gettext и
<code class="docutils literal notranslate"><span class="pre">-k</span> <span class="pre">__</span></code> для lazy gettext (два подчеркивания).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pybabel<span class="w"> </span>extract<span class="w"> </span>-o<span class="w"> </span>locales/messages.pot<span class="w"> </span>-k<span class="w"> </span>_:1,1t<span class="w"> </span>-k<span class="w"> </span>_:1,2<span class="w"> </span>-k<span class="w"> </span>__<span class="w"> </span><span class="se">\</span>
--copyright-holder<span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="w"> </span><span class="se">\</span>
--project<span class="o">=</span><span class="s2">&quot;Bot Super Project&quot;</span><span class="w"> </span><span class="se">\</span>
--version<span class="o">=</span><span class="m">0</span>.1.1<span class="w"> </span>--msgid-bugs-address<span class="o">=</span>john@doe-email.com<span class="w"> </span><span class="se">\</span>
--input-dirs<span class="o">=</span>.
</pre></div>
</div>
<p>Babel может неадекватно извлекать строки, поэтому можно воспользоваться
командой <code class="docutils literal notranslate"><span class="pre">xgettext</span></code> из пакета утилит GNU gettext.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xgettext<span class="w"> </span>-L<span class="w"> </span>Python<span class="w"> </span>--keyword<span class="o">=</span>_:1,2<span class="w"> </span>--keyword<span class="o">=</span>__<span class="w"> </span>-d<span class="w"> </span>my-super-bot
</pre></div>
</div>
<p>Заглянем в наш шаблон <code class="docutils literal notranslate"><span class="pre">.pot</span></code>, и увидим, что теперь перевод имеет
строку для перевода единственного и множественного числа:</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">locales/messages.pot</span><a class="headerlink" href="#id12" title="Link to this code"></a></div>
<div class="highlight-pot notranslate"><div class="highlight"><pre><span></span><span class="linenos">33</span><span class="kd">#: lesson1.py:22</span>
<span class="linenos">34</span><span class="nv">msgid</span> <span class="s">&quot;You have {} coin!&quot;</span>
<span class="linenos">35</span><span class="nv">msgid_plural</span> <span class="s">&quot;You have {} coins!&quot;</span>
<span class="linenos">36</span><span class="nv">msgstr[</span><span class="mi">0</span><span class="nv">]</span> <span class="s">&quot;&quot;</span>
<span class="linenos">37</span><span class="nv">msgstr[</span><span class="mi">1</span><span class="nv">]</span> <span class="s">&quot;&quot;</span>
</pre></div>
</div>
</div>
<p>Обновим перевод каждой из локалей:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pybabel<span class="w"> </span>update<span class="w"> </span>-i<span class="w"> </span>locales/messages.pot<span class="w"> </span>-d<span class="w"> </span>locales<span class="w"> </span>-D<span class="w"> </span>my-super-bot<span class="w"> </span>-l<span class="w"> </span>ru
</pre></div>
</div>
<p>и</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pybabel<span class="w"> </span>update<span class="w"> </span>-i<span class="w"> </span>locales/messages.pot<span class="w"> </span>-d<span class="w"> </span>locales<span class="w"> </span>-D<span class="w"> </span>my-super-bot<span class="w"> </span>-l<span class="w"> </span>en
</pre></div>
</div>
<p>При генерации Babel по коду языка сгенерировал в файле .po для каждого
языка свою формулу определения форм слова, а также сами строки для
правильного перевода каждой формы.</p>
<p>В английской версии у нас две формы единственное и множественное число:</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">locales/en/LC_MESSAGES/my-super-bot.po</span><a class="headerlink" href="#id13" title="Link to this code"></a></div>
<div class="highlight-po notranslate"><div class="highlight"><pre><span></span><span class="linenos">16</span><span class="s">&quot;</span><span class="py">Plural-Forms:</span><span class="s"> nplurals=2; plural=(n != 1);\n&quot;</span>
</pre></div>
</div>
</div>
<div class="highlight-po notranslate"><div class="highlight"><pre><span></span><span class="linenos">31</span><span class="kd">#: lesson1.py:22</span>
<span class="linenos">32</span><span class="nv">msgid</span> <span class="s">&quot;You have {} coin!&quot;</span>
<span class="linenos">33</span><span class="nv">msgid_plural</span> <span class="s">&quot;You have {} coins!&quot;</span>
<span class="linenos">34</span><span class="nv">msgstr[</span><span class="mi">0</span><span class="nv">]</span> <span class="s">&quot;&quot;</span>
<span class="linenos">35</span><span class="nv">msgstr[</span><span class="mi">1</span><span class="nv">]</span> <span class="s">&quot;&quot;</span>
</pre></div>
</div>
<p>Ниже Babel пометил старые строки удаленными с помощью комментария
<code class="docutils literal notranslate"><span class="pre">#~</span></code>. (У меня не было перевода в английском файле, я забыл их
добавить. Поэтому строка <code class="docutils literal notranslate"><span class="pre">msgstr</span></code> пустая.) Babel посчитал их не
нужными, потому что теперь появились такие же строки с множественными
формами)</p>
<div class="highlight-po notranslate"><div class="highlight"><pre><span></span><span class="linenos">37</span><span class="c1">#~ msgid &quot;You have {} coins!&quot;</span>
<span class="linenos">38</span><span class="c1">#~ msgstr &quot;&quot;</span>
</pre></div>
</div>
<p>В русском языке три множественных формы. Единственное, малое множественное и множественное:</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">locales/ru/LC_MESSAGES/my-super-bot.po</span><a class="headerlink" href="#id14" title="Link to this code"></a></div>
<div class="highlight-po notranslate"><div class="highlight"><pre><span></span><span class="linenos">16</span><span class="s">&quot;</span><span class="py">Plural-Forms:</span><span class="s"> nplurals=3; plural=(n%10==1 &amp;&amp; n%100!=11 ? 0 : n%10&gt;=2 &amp;&amp; &quot;</span>
<span class="linenos">17</span><span class="s">&quot;n%10&lt;=4 &amp;&amp; (n%100&lt;10 || n%100&gt;=20) ? 1 : 2);\n&quot;</span>
</pre></div>
</div>
</div>
<div class="highlight-po notranslate"><div class="highlight"><pre><span></span><span class="linenos">31</span><span class="kd">#: lesson1.py:22</span>
<span class="linenos">32</span><span class="kt">#, fuzzy</span>
<span class="linenos">33</span><span class="nv">msgid</span> <span class="s">&quot;You have {} coin!&quot;</span>
<span class="linenos">34</span><span class="nv">msgid_plural</span> <span class="s">&quot;You have {} coins!&quot;</span>
<span class="linenos">35</span><span class="nv">msgstr[</span><span class="mi">0</span><span class="nv">]</span> <span class="s">&quot;У Вас {} монет!&quot;</span>
<span class="linenos">36</span><span class="nv">msgstr[</span><span class="mi">1</span><span class="nv">]</span> <span class="s">&quot;&quot;</span>
<span class="linenos">37</span><span class="nv">msgstr[</span><span class="mi">2</span><span class="nv">]</span> <span class="s">&quot;&quot;</span>
</pre></div>
</div>
<p>Здесь Babel сохранил наш старый перевод из предыдущего файла <code class="docutils literal notranslate"><span class="pre">.po</span></code>, именно поэтому я говорил,
что они нам нужны в ветке development. Он пометил данный перевод как неточный <code class="docutils literal notranslate"><span class="pre">fuzzy</span></code>, чтоб мы исправили.</p>
<p>Вернемся теперь к формуле. Формула для вычисления множественных форм - это обычная тернарная
условная операция на СИ-подобном языке вида <code class="docutils literal notranslate"><span class="pre">condition</span> <span class="pre">?</span> <span class="pre">true</span> <span class="pre">:</span> <span class="pre">false</span></code>.
И именно для ее работы мы компилируем переводы.</p>
<p>Итак, в английском у нас две формы слова: <code class="docutils literal notranslate"><span class="pre">nplurals=2</span></code>. А <code class="docutils literal notranslate"><span class="pre">plural=(n</span> <span class="pre">!=</span> <span class="pre">1);\n&quot;</span></code>
означает формулу вычисления, по которой определяется надо ли ставить фразу в единственном числе или множественном,
в зависимости от переданного <code class="docutils literal notranslate"><span class="pre">n</span></code>:</p>
<ul class="simple">
<li><p>если полученное в основном коде из нашей функции <code class="docutils literal notranslate"><span class="pre">_(&quot;You</span> <span class="pre">have</span> <span class="pre">{}</span> <span class="pre">coin!&quot;,</span> <span class="pre">&quot;You</span> <span class="pre">have</span> <span class="pre">{}</span> <span class="pre">coins!&quot;,</span> <span class="pre">n).format(n))</span></code> число <code class="docutils literal notranslate"><span class="pre">n</span></code> равно 1, то
выражение <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">!=</span> <span class="pre">1</span></code> возвращает 0 (То есть False. False неявно приводится к int и равно 0), и строки берутся из <code class="docutils literal notranslate"><span class="pre">msgstr[0]</span></code>.
Это единственное число.</p></li>
<li><p>если n не равно 1, то выражение <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">!=</span> <span class="pre">1</span></code>, то возвращает 1 (True) и
форма слова является множественным числом. Берутся данные из <code class="docutils literal notranslate"><span class="pre">msgstr[1]</span></code>.</p></li>
</ul>
<p>Заполняем:</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">locales/en/LC_MESSAGES/my-super-bot.po</span><a class="headerlink" href="#id15" title="Link to this code"></a></div>
<div class="highlight-po notranslate"><div class="highlight"><pre><span></span><span class="kd">#: lesson1.py:22</span>
<span class="nv">msgid</span> <span class="s">&quot;You have {} coin!&quot;</span>
<span class="nv">msgid_plural</span> <span class="s">&quot;You have {} coins!&quot;</span>
<span class="nv">msgstr[</span><span class="mi">0</span><span class="nv">]</span> <span class="s">&quot;You have {} coin!&quot;</span>
<span class="nv">msgstr[</span><span class="mi">1</span><span class="nv">]</span> <span class="s">&quot;You have {} coins!&quot;</span>
</pre></div>
</div>
</div>
<p>Если же для языка нет перевода, то отобразятся строки <code class="docutils literal notranslate"><span class="pre">msgid</span></code> «You have {} coin!» и <code class="docutils literal notranslate"><span class="pre">msgid_plural</span></code> «You have {} coins!»</p>
<p>В русском языке три формы слова <code class="docutils literal notranslate"><span class="pre">nplurals=3</span></code>. Формула
<code class="docutils literal notranslate"><span class="pre">plural=(n%10==1</span> <span class="pre">&amp;&amp;</span> <span class="pre">n%100!=11</span> <span class="pre">?</span> <span class="pre">0</span> <span class="pre">:</span> <span class="pre">n%10&gt;=2</span> <span class="pre">&amp;&amp;</span> <span class="pre">&quot;</span> <span class="pre">&quot;n%10&lt;=4</span> <span class="pre">&amp;&amp;</span> <span class="pre">(n%100&lt;10</span> <span class="pre">||</span> <span class="pre">n%100&gt;=20)</span> <span class="pre">?</span> <span class="pre">1</span> <span class="pre">:</span> <span class="pre">2);\n&quot;</span></code>
означает:</p>
<ul class="simple">
<li><p>Если выражение <code class="docutils literal notranslate"><span class="pre">n%10==1</span> <span class="pre">&amp;&amp;</span> <span class="pre">n%100!=11</span></code> верно и <code class="docutils literal notranslate"><span class="pre">n</span></code> заканчивается на
единицу, но не заканчивается на 11, то возвращается 0 (потому что в тернарном выражении
явно указано возвращать ноль после двоеточия). Берутся данные из
<code class="docutils literal notranslate"><span class="pre">msgstr[0]</span></code>. И это и единственное число. То есть 1 монета, 101
монета, но не 111 монет.</p></li>
<li><p>Иначе: вычисляем <code class="docutils literal notranslate"><span class="pre">n%10&gt;=2</span> <span class="pre">&amp;&amp;</span> <span class="pre">n%10&lt;=4</span> <span class="pre">&amp;&amp;</span> <span class="pre">(n%100&lt;10</span> <span class="pre">||</span> <span class="pre">n%100&gt;=20)</span></code>,
это форма для чисел, заканчивающихся на 2, 3 и 4. Например, 3 монеты
и 44 монеты. Если выражение верно, то возвращаем 1. Берутся данные из
<code class="docutils literal notranslate"><span class="pre">msgstr[1]</span></code>.</p></li>
<li><p>Иначе: возвращаем 2. И это остальные числа. 5, 11, 56, 110, 111 и т.д.
монет. Берутся данные из <code class="docutils literal notranslate"><span class="pre">msgstr[2]</span></code>.</p></li>
</ul>
<p>Выбор перевода это просто взятие k-го элемента <code class="docutils literal notranslate"><span class="pre">msgstr[k]</span></code>, где k
вычислено по этой формуле.</p>
<p>Из предыдущего перевода (старого файла .po, который мы специально не удаляли) у нас подставилась часть ранее переведенных строк.
Поэтому переводим недостающие элементы, не забываем удалить строки, помеченные для удаления, и метки неточного перевода fuzzy.</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">locales/ru/LC_MESSAGES/my-super-bot.po</span><a class="headerlink" href="#id16" title="Link to this code"></a></div>
<div class="highlight-po notranslate"><div class="highlight"><pre><span></span><span class="kd">#: lesson1.py:22</span>
<span class="nv">msgid</span> <span class="s">&quot;You have {} coin!&quot;</span>
<span class="nv">msgid_plural</span> <span class="s">&quot;You have {} coins!&quot;</span>
<span class="nv">msgstr[</span><span class="mi">0</span><span class="nv">]</span> <span class="s">&quot;У Вас {} монета!&quot;</span>
<span class="nv">msgstr[</span><span class="mi">1</span><span class="nv">]</span> <span class="s">&quot;У Вас {} монеты!&quot;</span>
<span class="nv">msgstr[</span><span class="mi">2</span><span class="nv">]</span> <span class="s">&quot;У Вас {} монет!&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="mo">
<h2>Компиляция переводов, файлы формата mo.<a class="headerlink" href="#mo" title="Link to this heading"></a></h2>
<p>Особенность работы с gettext и Babel заключается в том, что все файлы переводов должны быть предварительно
скомпилированы, поскольку перевод строк выбирается по индексам, рассчитанным по формулам.</p>
<p>Компилируем переводы командой:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pybabel<span class="w"> </span>compile<span class="w"> </span>-d<span class="w"> </span>locales<span class="w"> </span>-D<span class="w"> </span>my-super-bot
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">-d</span></code> - имя директории locales</p>
<p><code class="docutils literal notranslate"><span class="pre">-D</span></code> - домен «my-super-bot»</p>
<p>И получаем в нашей локали файлы <code class="docutils literal notranslate"><span class="pre">.mo</span></code>, радом с файлами <code class="docutils literal notranslate"><span class="pre">.po</span></code>.</p>
<p>Файлы <code class="docutils literal notranslate"><span class="pre">.mo</span></code> храним в репозитории в ветке production, и распространяем с программой.
В отличие от файлов <code class="docutils literal notranslate"><span class="pre">.po</span></code>, которые предназначены для разработки и хранятся в ветке development.</p>
</section>
<section id="id4">
<h2>Финальный результат.<a class="headerlink" href="#id4" title="Link to this heading"></a></h2>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">lesson1.py</span><a class="headerlink" href="#id17" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">aiogram</span> <span class="kn">import</span> <span class="n">Bot</span><span class="p">,</span> <span class="n">Dispatcher</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">html</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">aiogram.types</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kn">from</span> <span class="nn">aiogram.utils.i18n</span> <span class="kn">import</span> <span class="n">gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="linenos"> 5</span><span class="kn">from</span> <span class="nn">aiogram.utils.i18n</span> <span class="kn">import</span> <span class="n">lazy_gettext</span> <span class="k">as</span> <span class="n">__</span>
<span class="linenos"> 6</span><span class="kn">from</span> <span class="nn">aiogram.utils.i18n</span> <span class="kn">import</span> <span class="n">I18n</span><span class="p">,</span> <span class="n">ConstI18nMiddleware</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="n">TOKEN</span> <span class="o">=</span> <span class="s2">&quot;token&quot;</span>
<span class="linenos"> 9</span><span class="n">dp</span> <span class="o">=</span> <span class="n">Dispatcher</span><span class="p">()</span>
<span class="linenos">10</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="n">__</span><span class="p">(</span><span class="s2">&quot;Start&quot;</span><span class="p">))</span>
<span class="linenos">13</span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler_1</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">14</span>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Welcome, </span><span class="si">{name}</span><span class="s2">!&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">html</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">full_name</span><span class="p">)))</span>
<span class="linenos">15</span>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;How many coins do you have? Input number, please:&quot;</span><span class="p">))</span>
<span class="linenos">16</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="linenos">19</span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler_2</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">20</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">21</span>        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="linenos">22</span>        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;You have </span><span class="si">{}</span><span class="s2"> coin!&quot;</span><span class="p">,</span> <span class="s2">&quot;You have </span><span class="si">{}</span><span class="s2"> coins!&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<span class="linenos">23</span>    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="linenos">24</span>        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Please, enter a number&quot;</span><span class="p">))</span>
<span class="linenos">25</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">28</span>    <span class="n">bot</span> <span class="o">=</span> <span class="n">Bot</span><span class="p">(</span><span class="n">TOKEN</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s2">&quot;HTML&quot;</span><span class="p">)</span>
<span class="linenos">29</span>    <span class="n">i18n</span> <span class="o">=</span> <span class="n">I18n</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;locales&quot;</span><span class="p">,</span> <span class="n">default_locale</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;my-super-bot&quot;</span><span class="p">)</span>
<span class="linenos">30</span>    <span class="n">dp</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">outer_middleware</span><span class="p">(</span><span class="n">ConstI18nMiddleware</span><span class="p">(</span><span class="n">locale</span><span class="o">=</span><span class="s1">&#39;ru&#39;</span><span class="p">,</span> <span class="n">i18n</span><span class="o">=</span><span class="n">i18n</span><span class="p">))</span>
<span class="linenos">31</span>    <span class="n">dp</span><span class="o">.</span><span class="n">run_polling</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Запускаем код, указываем константный русский язык в строке:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">30</span><span class="n">dp</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">outer_middleware</span><span class="p">(</span><span class="n">ConstI18nMiddleware</span><span class="p">(</span><span class="n">locale</span><span class="o">=</span><span class="s1">&#39;ru&#39;</span><span class="p">,</span> <span class="n">i18n</span><span class="o">=</span><span class="n">i18n</span><span class="p">))</span>
</pre></div>
</div>
<p>Тестируем. Меняем значение на <code class="docutils literal notranslate"><span class="pre">locale='en'</span></code> и снова запускаем и
тестируем.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">30</span><span class="n">dp</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">outer_middleware</span><span class="p">(</span><span class="n">ConstI18nMiddleware</span><span class="p">(</span><span class="n">locale</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="n">i18n</span><span class="o">=</span><span class="n">i18n</span><span class="p">))</span>
</pre></div>
</div>
<p>Для динамического переключения языков, нам нужно хранить язык в базе
данных и реализовать свой класс middleware на базе <code class="docutils literal notranslate"><span class="pre">I18nMiddleware</span></code> из
<code class="docutils literal notranslate"><span class="pre">aiogram.utils.i18n.middleware</span></code>. Это мы сделаем чуть позже. А пока
разберемся с еще одним инструментом для локализации и
интернационализации на базе проекта Fluent от Mozilla.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Нижняя область">
        <a href="chapter_02.html" class="btn btn-neutral float-left" title="Глава 2. Интернационализация в Aiogram утилитами GNU gettext." accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Предыдущая</a>
        <a href="chapter_04.html" class="btn btn-neutral float-right" title="Глава 4. Локализация и интернационализация на базе проект Fluent от Mozilla." accesskey="n" rel="next">Следующая <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Авторские права 2024, Vergily. </p>
  </div>

  Собрано при помощи <a href="https://www.sphinx-doc.org/">Sphinx</a> с использованием
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">темы,</a>
    предоставленной <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>